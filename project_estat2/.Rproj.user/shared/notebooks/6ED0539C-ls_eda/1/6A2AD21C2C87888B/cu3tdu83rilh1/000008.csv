"0",""
"0","f_sd <- 2"
"0","f_beta <- 0"
"0","f_pvalue <- 0.05"
"0","f_correl <- 0.6"
"0","out_signal <- 0.05"
"0",""
"0","# Gera o sinal de entrada"
"0","teste$signal_t1 <- with(teste, ifelse(lag(scale_t1) < f_sd & scale_t1 >= f_sd, 2,"
"0","                                      ifelse(lag(scale_t1) > -f_sd & scale_t1 <= -f_sd, -2, 0)))"
"0","# Gera o filtro de entrada"
"0","teste$filter_t1 <- with(teste, ifelse(beta_t1 > f_beta & pvalue_t1 < f_pvalue & correl_t1 > f_correl, 1, 0))"
"0",""
"0","# Gera o sinal de saída"
"0","teste$out_t1 <- with(teste, ifelse(lag(scale_t1) > out_signal & scale_t1 <= out_signal, 1,"
"0","                                   ifelse(lag(scale_t1) < -out_signal & scale_t1 >= -out_signal, -1, 0)))"
"0",""
"0","# Elimina NA da primeira linha causado pelo lag"
"0","teste$signal_t1[is.na(teste$signal_t1)] <- 0"
"0","teste$out_t1[is.na(teste$out_t1)] <- 0"
"0",""
"0","# em teoria somente a primeira linha pode ser NA"
"0","teste$pos_t1 <- 0"
"0",""
"0","# Define se estou posicionado ou não"
"0","active <- 0"
"0",""
"0","for(i in 2:nrow(teste)){"
"0","  # Active = 0 & (Signal = 0 | Filter = 0)"
"0","  if (active == 0 & (teste$signal_t1[i] == 0 | teste$filter_t1[i] == 0)) {"
"0","    teste$pos_t1[i] <- 0"
"0","  # Active = 0 & (Signal = 2 & Filter = 1) & Out = 0"
"0","  } else if (active == 0 & (teste$signal_t1[i] == 2 & teste$filter_t1[i] == 1)) {"
"0","    active <- 1"
"0","    teste$pos_t1[i+1] <- -1"
"0","    # Active = 0 & (Signal = -2 & Filter = 1) & Out = 0"
"0","  } else if (active == 0 & (teste$signal_t1[i] == -2 & teste$filter_t1[i] == 1)) {"
"0","    active <- 1"
"0","    teste$pos_t1[i+1] <- 1"
"0","    # Active = 1 & Out = 0"
"0","  } else if (active == 1 & teste$out_t1[i] == 0) {"
"0","    teste$pos_t1[i] <- teste$pos_t1[i-1]"
"0","    # Active = 1 & (Signal = 2 & Filter = 1) & Out = 1"
"0","  } else if (active == 1 & (teste$signal_t1[i] == 2 & teste$filter_t1[i] == 1) & teste$out_t1[i] != 0) {"
"0","    teste$pos_t1[i] <- -1"
"0","    # Active = 1 & (Signal = -2 & Filter = 1) & Out = 1"
"0","  } else if (active == 1 & (teste$signal_t1[i] == -2 & teste$filter_t1[i] == 1) & teste$out_t1[i] != 0) {"
"0","    teste$pos_t1[i] <- 1"
"0","    # Active = 1 & (Signal = 0 & Filter = 0) & Out = 1"
"0","  } else if (active == 1 & (teste$signal_t1[i] == 0 | teste$filter_t1[i] == 0) & teste$out_t1[i] != 0) {"
"0","    active <- 0"
"0","    teste$pos_t1[i] <- teste$pos_t1[i-1]"
"0","  }"
"0","}"
"0",""
"0",""
"0","# Gera os retornos dos dias posicionados"
"0","#teste$return_t1 <- with(teste, ifelse(signal_t1 != 0, 0, ((price_l / lag(price_l)-1) - beta_t1 * (price_r / lag(price_r)-1)) * pos_t1))"
"0","teste$return_t1 <- with(teste, ((price_l / lag(price_l)-1) - beta_t1 * (price_r / lag(price_r)-1)) * pos_t1)"
"0",""
"0","# Elimina NA da primeira linha causado pelo lag"
"0","teste$return_t1[is.na(teste$return_t1)] <- 0"
"0",""
"0","# Numerar a posição e o lucro"
"0","teste$trade_t1 <- 0"
"0","teste$sum_ret_t1 <- 0"
"0","teste$open_days_t1 <- 0"
"0",""
"0","active <- 0"
"0","open_line <- 0"
"0","counter <- 0"
"0","count_days <- 0"
"0","sum_ret <- 0"
"0",""
"0","system.time("
"0",""
"0","for(i in 1:nrow(teste)){"
"0","  # Active = 0 & Signal = 0"
"0","  if(active == 0 & (teste$signal_t1[i] == 0 | teste$filter_t1[i] == 0)){"
"0","    # Active = 0 & Signal = 1"
"0","  } else if (active == 0 & (teste$signal_t1[i] != 0  & teste$filter_t1[i] != 0)) {"
"0","    active <- 1"
"0","    open_line <- i"
"0","    counter <- counter + 1"
"0","    teste$trade_t1[i] <- counter"
"0","    sum_ret <- 0"
"0","    count_days <- 0"
"0","    # Active = 1 & Out = 0 & Signal = 0"
"0","  } else if (active == 1 & teste$out_t1[i] == 0 & (teste$signal_t1[i] == 0 | teste$filter_t1[i] == 0)) {"
"0","    sum_ret <- sum_ret + teste$return_t1[i]"
"0","    count_days <- count_days + 1"
"0","    # Active = 1 & Out = 0 & Signal = 1"
"0","  } else if(active == 1 & teste$out_t1[i] == 0 & (teste$signal_t1[i] != 0 & teste$filter_t1[i] != 0)) {"
"0","    sum_ret <- sum_ret + teste$return_t1[i]"
"0","    count_days <- count_days + 1"
"0","    # Active = 1 & Out = 1 & Signal = 0"
"0","  } else if (active == 1 & teste$out_t1[i] != 0 & (teste$signal_t1[i] == 0 | teste$filter_t1[i] == 0)) {"
"0","    sum_ret <- sum_ret + teste$return_t1[i]"
"0","    count_days <- count_days + 1"
"0","    teste$sum_ret_t1[open_line] <- sum_ret"
"0","    teste$open_days_t1[open_line] <- count_days"
"0","    sum_ret <- 0"
"0","    count_days <- 0"
"0","    active <- 0"
"0","    # Active = 1 & Out = 1 & Signal = 1"
"0","  } else if(active == 1 & teste$out_t1[i] != 0 & (teste$signal_t1[i] != 0 & teste$filter_t1[i] != 0)) {"
"0","    sum_ret <- sum_ret + teste$return_t1[i]"
"0","    count_days <- count_days + 1"
"0","    teste$sum_ret_t1[open_line] <- sum_ret"
"0","    teste$open_days_t1[open_line] <- count_days"
"0","    open_line <- i"
"0","    counter <- counter + 1"
"0","    teste$trade_t1[i] <- counter"
"0","    sum_ret <- 0"
"0","    count_days <- 0"
"0","  } else {print(c(active, teste$out_t1[i], teste$signal_t1[i], teste$filter_t1[i]))}"
"0","}"
"0",""
"0",")"
"1","   user "
"1"," system "
"1","elapsed "
"1","
"
"1","  0.058 "
"1","  0.001 "
"1","  0.059 "
"1","
"
"0","write_csv(teste, ""teste_t1.csv"")"
"0",""
